services:
  # ==========================================
  # 对象存储: MinIO
  # ==========================================
  minio:
    image: minio/minio:latest
    container_name: imgvault-minio
    ports:
      - "9000:9000"     # S3 API
      - "9001:9001"     # Web Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # 图片处理: imgproxy (Go + libvips)
  # ==========================================
  imgproxy:
    image: darthsim/imgproxy:latest
    container_name: imgvault-imgproxy
    ports:
      - "8081:8080"
    environment:
      # S3/MinIO 后端配置
      IMGPROXY_USE_S3: "true"
      IMGPROXY_S3_ENDPOINT: "http://minio:9000"
      AWS_ACCESS_KEY_ID: "minioadmin"
      AWS_SECRET_ACCESS_KEY: "minioadmin"
      AWS_REGION: "us-east-1"

      # URL 签名（安全）
      IMGPROXY_KEY: "${IMGPROXY_KEY:-943b421c9eb07c830af81030552c86009268de4e532ba2ee2eab8247c6da0881}"
      IMGPROXY_SALT: "${IMGPROXY_SALT:-520f986b998545b4785e0defbc4f3c1203f22de2374a3d53cb7a7fe9fea309c5}"

      # 性能调优
      IMGPROXY_WORKERS: "4"
      IMGPROXY_REQUESTS_QUEUE_SIZE: "64"
      IMGPROXY_MAX_SRC_RESOLUTION: "50"
      IMGPROXY_MAX_ANIMATION_FRAMES: "100"
      IMGPROXY_DOWNLOAD_BUFFER_SIZE: "1048576"
      IMGPROXY_TTL: "2592000"

      # 内存优化
      IMGPROXY_MALLOC: "jemalloc"
      IMGPROXY_FREE_MEMORY_INTERVAL: "10"
      MALLOC_ARENA_MAX: "2"

      # 格式支持
      IMGPROXY_AUTO_WEBP: "true"
      IMGPROXY_AUTO_AVIF: "true"
      IMGPROXY_PREFERRED_FORMATS: "avif,webp,jpeg"
    depends_on:
      minio:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

volumes:
  minio-data:
    driver: local
