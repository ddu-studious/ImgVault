# 访问控制与图片可见性设计

## 概述

ImgVault 采用**双前端分离架构**，将用户端（公开）和管理端（认证）完全分离。本文档描述当前系统的访问控制模型和图片可见性逻辑。

---

## 当前可见性模型

### 核心规则

**所有正常状态（status=1）的图片对所有访客公开可见，无需登录。**

| 维度 | 规则 |
|---|---|
| 图片浏览 | 所有非删除状态的图片对所有人可见 |
| 图片搜索 | 按关键字搜索，结果为全局可见图片 |
| 图片上传 | 任何人均可上传，无需认证 |
| 图片详情 | 任何人可查看任意图片的元数据 |
| 图片下载 | 任何人可下载原图 |
| 管理操作 | 需要管理员 Token 认证 |

### 图片状态流转

```
上传 → status=1（正常/公开可见）
       ↓ 管理员软删除
       status=0（已删除/不可见）→ 管理员恢复 → status=1
       ↓ 管理员永久删除
       从数据库和 MinIO 彻底删除
```

### 用户端可见范围

用户端（`/imgvault/`）只能看到：

- `status=1` 的图片（正常状态）
- 按时间倒序排列
- 支持关键字搜索过滤

用户端**不可见**：
- 已删除的图片（status=0）
- 回收站内容
- 操作日志
- 系统统计数据
- 标签/相册管理操作

---

## 前端架构

### 用户端 `/imgvault/`

```
功能清单:
├── 图片上传（拖拽 / 点击选择）
├── 图片浏览（网格展示）
├── 图片搜索（关键字模糊搜索）
├── 图片详情（查看元数据 + 下载）
└── 主题切换（浅色 / 深色 / 跟随系统）
```

- **无需登录**
- **无侧边栏**，纯粹的图片浏览和上传体验
- **无管理功能**（无删除、无标签编辑、无相册管理）

### 管理端 `/imgvault/admin/`

```
功能清单:
├── 登录认证（密码 + JWT Token）
├── Dashboard 看板（统计概览）
├── 图片管理（列表 + 批量操作 + 删除）
├── 回收站管理（恢复 / 永久删除）
├── 标签管理（CRUD）
├── 相册管理（CRUD）
├── 操作日志（查看）
├── 系统监控（健康检查 + 缓存）
└── 主题切换（浅色 / 深色 / 跟随系统）
```

- **需要密码登录**
- Token 有效期 24 小时
- 所有 `/api/v1/admin/**` 接口需要 Bearer Token

---

## API 访问控制

### 公开接口（无需认证）

| 接口 | 方法 | 说明 |
|---|---|---|
| `/api/v1/images` | GET | 查询图片列表（仅 status=1） |
| `/api/v1/images/{id}` | GET | 查询图片详情 |
| `/api/v1/images/upload` | POST | 上传图片 |
| `/api/v1/images/{id}/download` | GET | 下载图片 |
| `/api/v1/images/{id}` | DELETE | 软删除图片 |
| `/api/v1/images/{id}/permanent` | DELETE | 永久删除图片 |
| `/api/v1/tags` | GET | 查询标签列表 |
| `/api/v1/tags` | POST | 创建标签 |
| `/api/v1/tags/{id}` | PUT/DELETE | 修改/删除标签 |
| `/api/v1/albums` | GET | 查询相册列表 |
| `/api/v1/albums` | POST | 创建相册 |
| `/api/v1/albums/{id}` | PUT/DELETE | 修改/删除相册 |
| `/actuator/health` | GET | 健康检查 |

### 认证接口（需要 Admin Token）

| 接口 | 方法 | 说明 |
|---|---|---|
| `/api/v1/admin/login` | POST | 管理员登录（例外：不需要 Token） |
| `/api/v1/admin/stats` | GET | 系统统计 |
| `/api/v1/admin/images` | GET | 管理员图片列表（含所有状态） |
| `/api/v1/admin/trash` | GET | 回收站列表 |
| `/api/v1/admin/trash/{id}/restore` | POST | 恢复图片 |
| `/api/v1/admin/batch-delete` | POST | 批量删除 |
| `/api/v1/admin/batch-tag` | POST | 批量打标签 |
| `/api/v1/admin/logs` | GET | 操作日志 |

### 认证机制

```
认证流程:
1. POST /api/v1/admin/login { password: "xxx" }
2. 验证成功 → 返回 { token: "xxx", expiresIn: 86400 }
3. 后续请求携带 Header: Authorization: Bearer <token>
4. AdminAuthInterceptor 拦截 /api/v1/admin/** 验证 Token
5. Token 过期/无效 → 返回 401
```

Token 实现：
- 算法：HMAC-SHA256
- 载荷：`expireAt.role`（过期时间戳 + 角色标识）
- 无外部 JWT 库依赖

---

## 安全边界说明

### 当前设计特点

1. **图片浏览是公开的**：任何人都能看到所有正常图片
2. **上传是公开的**：任何人都能上传图片
3. **管理操作受保护**：删除、恢复、批量操作需要认证
4. **单管理员模式**：仅支持一个管理员密码

### 已知限制

1. **无用户体系**：不区分上传者，所有图片属于同一个池
2. **删除接口公开**：`DELETE /api/v1/images/{id}` 不需要认证
3. **永久删除接口公开**：`DELETE /api/v1/images/{id}/permanent` 不需要认证
4. **标签/相册 CRUD 公开**：创建、修改、删除标签和相册不需要认证

### 未来增强方向

| 方向 | 说明 | 优先级 |
|---|---|---|
| 用户体系 | 每个用户只能看到自己上传的图片 | P1 |
| 上传认证 | 需要登录才能上传 | P1 |
| 删除保护 | 将删除接口移至 admin 路径下 | P0 |
| 标签/相册保护 | 将写操作移至 admin 路径下 | P1 |
| 分享链接 | 通过短链接分享特定图片 | P2 |
| 水印保护 | 公开图片自动添加水印 | P2 |

---

## 数据流示意

```
┌─────────────────────────────────────────────────────┐
│                    Nginx (反向代理)                    │
├──────────────┬──────────────┬───────────────────────┤
│ /imgvault/   │/imgvault/admin/│/imgvault/api/v1/     │
│ 用户前端     │  管理前端     │   后端 API             │
│ (静态文件)   │ (静态文件)    │   (Spring Boot)       │
└──────┬───────┴──────┬───────┴───────────────────────┘
       │              │                    │
       │              │         ┌──────────┴──────────┐
       │              │         │                     │
       │              │    公开接口             Admin 接口
       │              │   (无需认证)         (需 Bearer Token)
       │              │         │                     │
       │              └─────────┤   AdminAuthInterceptor
       │                        │         │
       └────────────────────────┘         │
                                    验证 Token
                                   (HMAC-SHA256)
```

---

**文档版本**: 1.0
**创建时间**: 2026-02-15
**维护者**: ImgVault Team
