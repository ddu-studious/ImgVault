# ImgVault v2.1.0 - 轻量化混合架构重构 需求文档

**版本**: v2.1.0  
**创建日期**: 2026-02-13  
**状态**: 规划中  
**项目代号**: ImgVault  
**前置版本**: v2.0.0（图片存储查询服务）

---

## 1. 需求背景

### 1.1 版本定位

本版本是 v2.0.0 的**架构演进版本**，核心目标是：

- **降低部署成本**：去掉 MySQL、Redis、RocketMQ 等重量级中间件，用轻量级方案替代
- **提升图片处理性能**：引入 imgproxy（Go + libvips）替代 Java 原生图片处理
- **简化运维复杂度**：Docker Compose 一键部署，总内存需求从 ~3GB 降至 ~500MB

### 1.2 变更动机

基于两份技术调研报告的核心结论：

| 调研结论 | 来源 | 本版本响应 |
|---------|------|-----------|
| Go + libvips 是图片处理性能天花板 | 多语言对比调研 | 引入 imgproxy（Go + libvips） |
| Java 擅长业务编排，Go 擅长图片处理 | 多语言对比调研 | Java + Go 混合架构 |
| imgproxy 开箱即用（10.4k stars） | 多语言对比调研 | 直接复用，免开发图片处理层 |
| 原图必须无损直存 | 两份调研均强调 | 字节流直写 MinIO，零重编码 |
| Java 图片处理性能是短板 | Java 生态调研 | 图片处理完全交给 imgproxy |
| 个人/小团队适合轻量化起步 | Java 生态调研 | 去掉 MySQL/Redis/RocketMQ |

### 1.3 与 v2.0.0 的核心差异

| 维度 | v2.0.0 | v2.1.0 | 变更理由 |
|------|--------|--------|---------|
| **数据库** | MySQL 8.0 | **SQLite (WAL 模式)** | 零部署、零运维、内存省 1GB+ |
| **缓存** | Redis 6.x | **Caffeine (本地缓存)** | 零部署、进程内、纳秒级延迟 |
| **消息队列** | RocketMQ 4.9.x | **Spring Async Event + SQLite 任务表** | 去掉独立中间件，简化部署 |
| **图片处理** | Thumbnailator + TwelveMonkeys (Java) | **imgproxy (Go + libvips)** | 性能提升 5-10x，格式支持全面 |
| **架构模式** | Java 全栈 (DDD) | **Java 业务层 + imgproxy 处理层** | 各取所长的混合架构 |
| **部署容器数** | 4 个 (MySQL + Redis + RocketMQ + MinIO) | **2 个 (MinIO + imgproxy)** | 大幅降低资源和运维成本 |
| **内存需求** | ~3GB+ | **~500MB** | 节省 80%+ 的内存资源 |
| **Java 版本** | Java 8 | Java 8 | 保持不变 |
| **Spring Boot** | 2.7.x | 2.7.x | 保持不变 |

---

## 2. 技术选型变更

### 2.1 数据库：SQLite（替代 MySQL）

#### 选型理由

| 候选方案 | 优势 | 劣势 | 结论 |
|---------|------|------|------|
| **SQLite** | 零部署、文件级、WAL 并发读写、Java/Go 双端支持 | 并发写入有限（单写多读） | **推荐** |
| H2 Database | Java 嵌入式、SQL 兼容好 | 仅 Java 生态、Go 无法共享 | 不推荐 |
| DuckDB | 分析型高性能 | OLAP 导向，不适合 OLTP | 不推荐 |
| PostgreSQL (轻量) | 功能全面 | 仍需独立进程和内存 | 不推荐 |

#### SQLite 关键配置

```properties
# Spring Boot 数据源配置
spring.datasource.url=jdbc:sqlite:data/imgvault.db
spring.datasource.driver-class-name=org.sqlite.JDBC

# HikariCP 连接池（SQLite 特殊配置）
spring.datasource.hikari.maximum-pool-size=1
spring.datasource.hikari.minimum-idle=1
spring.datasource.hikari.connection-init-sql=PRAGMA journal_mode=WAL; PRAGMA synchronous=NORMAL; PRAGMA foreign_keys=ON; PRAGMA busy_timeout=5000;
```

#### Maven 依赖

```xml
<!-- SQLite JDBC 驱动 (兼容 Java 8) -->
<dependency>
    <groupId>org.xerial</groupId>
    <artifactId>sqlite-jdbc</artifactId>
    <version>3.46.1.3</version>
</dependency>
```

#### SQLite 性能预期

| 指标 | WAL 模式 | 说明 |
|------|---------|------|
| 写入吞吐 | ~3,000 writes/sec | 配合 `synchronous=NORMAL` |
| 并发读取 | 无限制 | WAL 模式下读写不互斥 |
| 并发写入 | 单写 (序列化) | 通过 `busy_timeout` 排队 |
| 数据库大小 | 建议 < 10GB | 超过后考虑迁移 MySQL |
| 适合场景 | 年图片量 < 50 万张 | 元数据查询为主 |

#### SQL 方言适配要点

| MySQL 语法 | SQLite 替代 | 说明 |
|-----------|------------|------|
| `AUTO_INCREMENT` | `AUTOINCREMENT` | 自增主键 |
| `DATETIME DEFAULT CURRENT_TIMESTAMP` | `DEFAULT (datetime('now'))` | 时间默认值 |
| `ON UPDATE CURRENT_TIMESTAMP` | 需通过触发器实现 | 更新时间 |
| `ENGINE=InnoDB` | 不需要 | SQLite 无引擎概念 |
| `BIGINT` | `INTEGER` | SQLite 动态类型 |
| `JSON` 类型 | `TEXT` | 存储 JSON 字符串 |
| `TINYINT` | `INTEGER` | SQLite 无 TINYINT |

#### 迁移路径

SQLite 是**启动阶段的轻量选择**，未来可平滑迁移：

```
SQLite (v2.1.0 轻量起步)
    ↓ 数据量增长 / 需要多实例
MySQL 8.0 或 PostgreSQL (v2.2.0+)
    ↓ 仅需修改: 数据源配置 + SQL 方言
```

---

### 2.2 缓存：Caffeine（替代 Redis）

#### 选型理由

| 维度 | Redis | Caffeine | 结论 |
|------|-------|----------|------|
| 部署成本 | 需要独立进程/容器 | **零部署，进程内** | Caffeine 胜 |
| 延迟 | ~1ms（网络往返） | **~100ns（内存直读）** | Caffeine 胜 |
| 内存占用 | 100MB+ 独立进程 | **JVM 堆内，按需分配** | Caffeine 胜 |
| 分布式一致性 | 天然支持 | 不支持（单实例） | Redis 胜 |
| 适用场景 | 多实例、分布式 | **单实例部署** | 视场景 |

#### Spring Boot 集成

```java
@Configuration
@EnableCaching
public class CacheConfig {

    @Bean
    public CacheManager cacheManager() {
        CaffeineCacheManager manager = new CaffeineCacheManager();
        manager.setCaffeine(Caffeine.newBuilder()
                .maximumSize(10_000)           // 最大缓存条目
                .expireAfterWrite(30, TimeUnit.MINUTES)  // 写入后 30 分钟过期
                .expireAfterAccess(10, TimeUnit.MINUTES) // 访问后 10 分钟过期
                .recordStats());               // 开启统计
        return manager;
    }
}
```

#### 缓存策略

| 缓存项 | TTL | 最大条目 | 说明 |
|--------|-----|---------|------|
| 图片元数据 | 30 分钟 | 10,000 | 按 imageId 缓存 |
| 标签列表 | 60 分钟 | 1,000 | 全量标签缓存 |
| 相册列表 | 30 分钟 | 500 | 按 userId 缓存 |
| 文件指纹 | 60 分钟 | 50,000 | 秒传快速查询 |
| 上传任务状态 | 24 小时 | 1,000 | 分片上传进度 |

#### 迁移路径

```
Caffeine 本地缓存 (v2.1.0 单实例)
    ↓ 需要多实例部署
Caffeine (L1) + Redis (L2) 双级缓存 (v2.2.0+)
    ↓ 仅需新增 Redis 依赖 + CompositeCacheManager
```

---

### 2.3 消息队列：Spring Async Event（替代 RocketMQ）

#### 替代方案

| 场景 | v2.0.0 方案 | v2.1.0 方案 |
|------|------------|------------|
| 缩略图异步生成 | RocketMQ 消息 | **Spring @Async + ApplicationEvent** |
| 格式转换任务 | RocketMQ 消息 | **SQLite 任务表 + 定时扫描** |
| EXIF 异步提取 | RocketMQ 消息 | **Spring @Async** |
| 任务失败重试 | RocketMQ 重试队列 | **SQLite 任务表 + 重试计数** |

#### SQLite 异步任务表

```sql
CREATE TABLE img_async_task (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_type TEXT NOT NULL,          -- 任务类型: thumbnail/convert/watermark/exif
    image_id INTEGER NOT NULL,        -- 关联图片ID
    payload TEXT,                     -- 任务参数 (JSON)
    status INTEGER DEFAULT 0,         -- 0-待处理 1-处理中 2-已完成 3-失败
    retry_count INTEGER DEFAULT 0,    -- 重试次数
    max_retries INTEGER DEFAULT 3,    -- 最大重试次数
    error_message TEXT,               -- 错误信息
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now')),
    executed_at TEXT                   -- 执行时间
);

CREATE INDEX idx_task_status ON img_async_task(status);
CREATE INDEX idx_task_type ON img_async_task(task_type, status);
```

#### 迁移路径

```
Spring Async + SQLite 任务表 (v2.1.0)
    ↓ 任务量增大 / 需要分布式
RocketMQ / RabbitMQ (v2.2.0+)
    ↓ 仅需替换 TaskService 实现
```

---

### 2.4 图片处理：imgproxy（替代 Java 原生处理）

#### 架构变更

```
v2.0.0 架构:
  上传 → Java 解码 → Thumbnailator 处理 → 编码 → MinIO
  （慢、内存高、格式有限）

v2.1.0 架构:
  上传 → 原图直存 MinIO（零处理）
  访问 → imgproxy 按需实时处理 → 返回（或 CDN 缓存）
  （快、内存低、格式全面、按需生成）
```

#### imgproxy 能力矩阵

| 功能 | v2.0.0 (Java) | v2.1.0 (imgproxy) | 提升 |
|------|--------------|-------------------|------|
| 缩略图生成 | Thumbnailator (Java ImageIO) | libvips (C) | 性能 5-10x |
| 水印添加 | Thumbnailator | libvips | 性能 5x |
| 格式转换 | JPEG/PNG/WebP (受限) | **JPEG/PNG/GIF/WebP/AVIF/TIFF/HEIC** | 格式全面 |
| AVIF 支持 | 不支持 | **原生支持** | 新增 |
| WebP 支持 | TwelveMonkeys 扩展 | **原生支持** | 原生化 |
| 图片压缩 | Java ImageIO | mozjpeg / libwebp | 质量更优 |
| 内存占用 | 200-300MB (处理时峰值 GB) | **50-100MB (流式处理)** | 降低 70%+ |
| 并发处理 | 线程池，受 GC 影响 | goroutine，低延迟 | 更稳定 |

#### imgproxy URL 格式

```
# 基本格式
/{processing_options}/plain/{source_url}

# 缩略图示例
/resize:150:150:1/plain/s3://imgvault/originals/2026/02/13/{uuid}.jpg

# 格式转换 + 质量控制
/resize:800:600/quality:85/plain/s3://imgvault/originals/2026/02/13/{uuid}.jpg@webp

# 水印
/watermark:0.5:ce:10:10/plain/s3://imgvault/originals/2026/02/13/{uuid}.jpg

# 智能裁剪
/resize:400:400:1/gravity:sm/plain/s3://imgvault/originals/2026/02/13/{uuid}.jpg
```

#### Java 服务调用 imgproxy

```java
/**
 * 生成 imgproxy 处理 URL
 * Java 服务负责 URL 签名和路由，imgproxy 负责实际处理
 */
@Service
public class ImageProcessingService {
    
    @Value("${imgproxy.base-url}")
    private String imgproxyBaseUrl;
    
    @Value("${imgproxy.key}")
    private String key;
    
    @Value("${imgproxy.salt}")
    private String salt;
    
    /**
     * 生成缩略图 URL（按需实时处理，无需预生成）
     */
    public String getThumbnailUrl(String storagePath, int width, int height) {
        String processingPath = String.format(
            "/resize:%d:%d:1/plain/s3://imgvault/%s", 
            width, height, storagePath
        );
        String signature = signUrl(processingPath);
        return imgproxyBaseUrl + "/" + signature + processingPath;
    }
    
    /**
     * 生成 WebP 格式 URL
     */
    public String getWebpUrl(String storagePath, int quality) {
        String processingPath = String.format(
            "/quality:%d/plain/s3://imgvault/%s@webp", 
            quality, storagePath
        );
        String signature = signUrl(processingPath);
        return imgproxyBaseUrl + "/" + signature + processingPath;
    }
}
```

---

## 3. 系统架构

### 3.1 整体架构（v2.1.0）

```
                         ┌──────────────────┐
                         │  客户端 / 浏览器   │
                         └────────┬─────────┘
                                  │
                    ┌─────────────┼──────────────┐
                    │             │              │
            ┌───────▼──────┐     │     ┌────────▼────────┐
            │ ImgVault API │     │     │  imgproxy        │
            │ (Java Spring │     │     │  (Go + libvips)  │
            │  Boot 2.7)   │     │     │  图片处理服务     │
            │              │     │     │                  │
            │ 业务逻辑层:   │     │     │ · 缩略图生成     │
            │ · 图片上传    │     │     │ · 格式转换       │
            │ · 元数据管理  │     │     │ · 水印添加       │
            │ · 标签/相册   │     │     │ · 图片压缩       │
            │ · 安全校验    │     │     │ · AVIF/WebP     │
            │ · URL 签名   │     │     │                  │
            └───────┬──────┘     │     └────────┬────────┘
                    │            │              │
                    │     ┌──────▼──────┐       │
                    │     │   MinIO     │       │
                    ├────►│  (S3 兼容)  │◄──────┘
                    │     │  对象存储   │
                    │     └─────────────┘
                    │
            ┌───────▼──────────────────────────┐
            │        轻量级基础设施              │
            │                                   │
            │  ┌──────────┐  ┌───────────────┐  │
            │  │  SQLite   │  │   Caffeine    │  │
            │  │ (WAL 模式) │  │  (本地缓存)   │  │
            │  │  元数据DB  │  │  热点数据     │  │
            │  └──────────┘  └───────────────┘  │
            │                                   │
            │  ┌───────────────────────────────┐│
            │  │  Spring Async Event           ││
            │  │  + SQLite 任务表              ││
            │  │  (替代 RocketMQ)              ││
            │  └───────────────────────────────┘│
            └───────────────────────────────────┘
```

### 3.2 请求流转

#### 图片上传流程

```
客户端 → [ImgVault API (Java)]
              │
              ├─ 1. 参数校验 + Magic Bytes 安全校验
              ├─ 2. SHA-256 哈希计算 → Caffeine 查询秒传
              ├─ 3. 原始字节流直写 MinIO（零重编码）
              ├─ 4. 存储后哈希比对（字节级一致性校验）
              ├─ 5. 保存元数据到 SQLite
              ├─ 6. Spring @Async 异步提取 EXIF
              └─ 7. 返回图片 URL + imgproxy 缩略图 URL
```

#### 图片访问流程

```
客户端请求缩略图 → [imgproxy]
                       │
                       ├─ 1. 解析 URL 中的处理参数
                       ├─ 2. 从 MinIO 读取原图（S3 协议）
                       ├─ 3. libvips 实时处理（缩放/裁剪/格式转换）
                       ├─ 4. 返回处理后的图片
                       └─ 5. (可选) CDN 缓存处理结果

客户端请求原图 → [MinIO Presigned URL]
                       │
                       └─ 直接从 MinIO 下载（绕过 Java 服务）
```

### 3.3 模块划分（精简版）

| 模块 | 说明 | 变更 |
|------|------|------|
| `imgvault-api` | 对外 API 服务 | **保留**，端口 8010 |
| `imgvault-admin` | 管理后台服务 | **保留**，端口 8011 |
| `imgvault-app` | 应用层 | **保留**，去掉 MQ 生产者 |
| `imgvault-common` | 公共模块 | **保留** |
| `imgvault-domain` | 领域层 | **保留** |
| `imgvault-infrastructure` | 基础设施层 | **重构**：SQLite 替代 MySQL，Caffeine 替代 Redis |
| `imgvault-task` | 异步任务服务 | **重构**：改为进程内异步任务，去掉独立部署 |

### 3.4 存储路径（不变）

```
imgvault/                          # MinIO Bucket
├── originals/                     # 原图（按日期: 2026/02/13/{uuid}.jpg）
│   └── 2026/02/13/{uuid}.jpg
├── temp/                          # 分片上传暂存
│   └── {uploadId}/
└── avatars/                       # 头像（业务扩展）
```

**注意**：v2.1.0 移除了 `thumbnails/` 和 `watermarked/` 目录 — 缩略图和水印图由 imgproxy **按需实时生成**，不再预生成存储。这大幅节省了存储空间。

---

## 4. 功能需求（阶段性开发）

### Phase 1 - 轻量化 MVP（3 周）

> 目标：搭建 Java + SQLite + Caffeine + MinIO 基础框架，完成核心上传/下载/查询

| ID | 功能模块 | 功能描述 | 优先级 | 验收标准 |
|----|---------|---------|--------|---------|
| F01 | 项目脚手架 | 搭建 Spring Boot 2.7 + SQLite + Caffeine + MinIO 基础框架 | P0 | 项目启动正常，SQLite WAL 模式生效 |
| F02 | 图片上传 | 单张/批量图片上传（JPEG/PNG/GIF/WebP/BMP） | P0 | 原图字节流直存 MinIO |
| F03 | 安全校验 | Magic Bytes + 类型白名单 + 大小限制 | P0 | 非法文件被拦截 |
| F04 | 图片查询 | 按 ID/UUID 查询图片信息 | P0 | 返回元数据 + MinIO 预签名 URL |
| F05 | 分页列表 | 按时间/格式/大小排序筛选 | P0 | 分页查询 P99 < 100ms |
| F06 | 图片下载 | 预签名 URL 下载原图 | P0 | 支持限时 URL |
| F07 | 图片删除 | 软删除 + 物理删除 | P0 | 软删除可恢复 |
| F08 | 元数据管理 | 自动提取尺寸、格式、大小信息 | P0 | 上传时自动提取并存储 |
| F09 | Caffeine 缓存 | 图片元数据 + 文件指纹缓存 | P0 | 热点查询命中缓存 |
| F10 | 健康检查 | /actuator/health 端点 | P0 | 含 SQLite/MinIO 健康状态 |

### Phase 2 - imgproxy 集成（2 周）

> 目标：引入 imgproxy，实现图片按需实时处理

| ID | 功能模块 | 功能描述 | 优先级 | 验收标准 |
|----|---------|---------|--------|---------|
| F11 | imgproxy 部署 | Docker Compose 集成 imgproxy + MinIO S3 后端 | P0 | imgproxy 可从 MinIO 读取原图 |
| F12 | 缩略图 URL | Java 服务生成 imgproxy 缩略图 URL | P0 | 返回 small/medium/large 三种规格 URL |
| F13 | URL 签名 | imgproxy URL 签名（防盗链） | P0 | 未签名 URL 返回 403 |
| F14 | 格式转换 | 支持 JPEG/PNG/WebP/AVIF 互转 | P1 | 通过 URL 参数指定输出格式 |
| F15 | 水印 URL | 生成带水印的图片 URL | P1 | 支持文字/图片水印 |
| F16 | 图片压缩 | 通过 URL 参数控制压缩质量 | P1 | 支持 1-100 质量级别 |
| F17 | 智能裁剪 | 基于内容的智能裁剪 | P2 | imgproxy gravity:sm 模式 |

### Phase 3 - 高级上传功能（2 周）

> 目标：实现秒传、分片上传、断点续传

| ID | 功能模块 | 功能描述 | 优先级 | 验收标准 |
|----|---------|---------|--------|---------|
| F18 | 秒传 | SHA-256 + MD5 双重哈希秒传 | P1 | Caffeine 缓存指纹，命中率 > 80% |
| F19 | 客户端直传 | 预签名 URL 客户端直传 MinIO | P1 | 生成预签名 PUT URL |
| F20 | 分片上传 | 大文件分片上传（> 5MB） | P1 | SQLite 记录分片状态 |
| F21 | 断点续传 | 网络中断后恢复上传 | P1 | 仅重传失败分片 |
| F22 | 异步 EXIF | Spring @Async 异步提取 EXIF 元数据 | P1 | 不阻塞上传响应 |
| F23 | 异步任务表 | SQLite 任务表 + 定时扫描执行 | P1 | 失败自动重试（最多 3 次） |

### Phase 4 - 管理功能（2 周）

> 目标：标签、相册、管理后台

| ID | 功能模块 | 功能描述 | 优先级 | 验收标准 |
|----|---------|---------|--------|---------|
| F24 | 标签管理 | 标签 CRUD + 按标签检索 | P1 | 支持多标签 |
| F25 | 相册管理 | 相册 CRUD + 图片关联 | P1 | 支持封面图 |
| F26 | 图片去重 | JImageHash 感知哈希 | P2 | 可配置相似度阈值 |
| F27 | EXIF 展示 | EXIF 元数据展示 + 隐私清理 | P2 | 可选移除 GPS |
| F28 | 管理后台 API | 图片浏览/搜索/统计 | P2 | Admin 端口 8082 |
| F29 | 操作日志 | 上传/删除/修改审计日志 | P2 | SQLite 日志表 |
| F30 | 回收站 | 软删除图片 30 天回收站 | P2 | 定时清理过期数据 |

### Phase 5 - 优化增强（持续迭代）

| ID | 功能模块 | 功能描述 | 优先级 |
|----|---------|---------|--------|
| F31 | 访问统计 | 图片访问量统计 | P2 |
| F32 | 批量操作 | 批量删除/打标签/下载 | P2 |
| F33 | CDN 集成 | CDN 回源 imgproxy | P2 |
| F34 | 数据库迁移 | SQLite → MySQL 迁移工具 | P3 |
| F35 | 缓存升级 | Caffeine → Caffeine + Redis 双级缓存 | P3 |

---

## 5. API 设计变更

### 5.1 API 整体不变

v2.1.0 对外 API 与 v2.0.0 **保持完全一致**，变更仅在内部实现层。客户端无需修改。

### 5.2 新增：图片处理 URL 返回

```json
// v2.0.0 返回（预生成的缩略图 URL）
{
    "thumbnails": {
        "small": "https://cdn.example.com/thumbnails/small/550e8400_s.jpg",
        "medium": "https://cdn.example.com/thumbnails/medium/550e8400_m.jpg"
    }
}

// v2.1.0 返回（imgproxy 实时处理 URL）
{
    "thumbnails": {
        "small": "https://imgproxy.example.com/{signature}/resize:150:150:1/plain/s3://imgvault/originals/2026/02/13/550e8400.jpg",
        "medium": "https://imgproxy.example.com/{signature}/resize:800:600/plain/s3://imgvault/originals/2026/02/13/550e8400.jpg",
        "large": "https://imgproxy.example.com/{signature}/resize:1920:1080/plain/s3://imgvault/originals/2026/02/13/550e8400.jpg"
    },
    "variants": {
        "webp": "https://imgproxy.example.com/{signature}/plain/s3://imgvault/originals/2026/02/13/550e8400.jpg@webp",
        "avif": "https://imgproxy.example.com/{signature}/plain/s3://imgvault/originals/2026/02/13/550e8400.jpg@avif"
    }
}
```

### 5.3 新增：图片处理参数化 API

```
# 动态生成任意规格的处理图片
GET /api/v1/images/{imageId}/process?width=400&height=300&format=webp&quality=85

# Java 服务生成签名后的 imgproxy URL 并 302 重定向
→ 302 Redirect to imgproxy URL
```

---

## 6. 数据库设计（SQLite 版）

### 6.1 核心表（SQLite 语法）

```sql
-- 图片主表
CREATE TABLE img_image (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    image_uuid TEXT NOT NULL UNIQUE,
    file_hash TEXT NOT NULL,
    file_md5 TEXT NOT NULL,
    original_name TEXT,
    storage_path TEXT NOT NULL,
    bucket_name TEXT NOT NULL DEFAULT 'imgvault',
    file_size INTEGER NOT NULL,
    width INTEGER,
    height INTEGER,
    format TEXT NOT NULL,
    mime_type TEXT NOT NULL,
    color_space TEXT,
    has_alpha INTEGER DEFAULT 0,
    uploader_id INTEGER,
    upload_source TEXT,
    status INTEGER DEFAULT 1,        -- 0-删除 1-正常 2-审核中
    access_level INTEGER DEFAULT 0,   -- 0-公开 1-私有 2-受限
    view_count INTEGER DEFAULT 0,
    description TEXT,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now')),
    deleted_at TEXT
);

CREATE INDEX idx_image_hash ON img_image(file_hash);
CREATE INDEX idx_image_md5 ON img_image(file_md5);
CREATE INDEX idx_image_uploader ON img_image(uploader_id);
CREATE INDEX idx_image_status ON img_image(status);
CREATE INDEX idx_image_created ON img_image(created_at);
CREATE INDEX idx_image_format ON img_image(format);
CREATE UNIQUE INDEX idx_image_uuid ON img_image(image_uuid);

-- 更新时间触发器
CREATE TRIGGER update_image_timestamp 
    AFTER UPDATE ON img_image
    FOR EACH ROW
BEGIN
    UPDATE img_image SET updated_at = datetime('now') WHERE id = NEW.id;
END;

-- 图片 EXIF 元数据表
CREATE TABLE img_metadata (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    image_id INTEGER NOT NULL UNIQUE,
    camera_make TEXT,
    camera_model TEXT,
    lens_model TEXT,
    focal_length TEXT,
    aperture TEXT,
    shutter_speed TEXT,
    iso INTEGER,
    taken_at TEXT,
    gps_latitude REAL,
    gps_longitude REAL,
    orientation INTEGER,
    raw_exif TEXT,                    -- JSON 字符串
    created_at TEXT DEFAULT (datetime('now')),
    FOREIGN KEY (image_id) REFERENCES img_image(id)
);

CREATE INDEX idx_metadata_taken ON img_metadata(taken_at);

-- 标签表
CREATE TABLE img_tag (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    usage_count INTEGER DEFAULT 0,
    created_at TEXT DEFAULT (datetime('now'))
);

-- 图片-标签关联表
CREATE TABLE img_image_tag (
    image_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    created_at TEXT DEFAULT (datetime('now')),
    PRIMARY KEY (image_id, tag_id),
    FOREIGN KEY (image_id) REFERENCES img_image(id),
    FOREIGN KEY (tag_id) REFERENCES img_tag(id)
);

CREATE INDEX idx_image_tag_tag ON img_image_tag(tag_id);

-- 相册表
CREATE TABLE img_album (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    description TEXT,
    cover_image_id INTEGER,
    owner_id INTEGER NOT NULL,
    image_count INTEGER DEFAULT 0,
    access_level INTEGER DEFAULT 0,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_album_owner ON img_album(owner_id);

-- 相册-图片关联表
CREATE TABLE img_album_image (
    album_id INTEGER NOT NULL,
    image_id INTEGER NOT NULL,
    sort_order INTEGER DEFAULT 0,
    created_at TEXT DEFAULT (datetime('now')),
    PRIMARY KEY (album_id, image_id),
    FOREIGN KEY (album_id) REFERENCES img_album(id),
    FOREIGN KEY (image_id) REFERENCES img_image(id)
);

CREATE INDEX idx_album_image_image ON img_album_image(image_id);

-- 文件指纹表（秒传用）
CREATE TABLE file_fingerprint (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    file_hash TEXT NOT NULL UNIQUE,
    file_md5 TEXT NOT NULL,
    storage_path TEXT NOT NULL,
    file_size INTEGER NOT NULL,
    ref_count INTEGER DEFAULT 1,
    created_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_fingerprint_hash ON file_fingerprint(file_hash);
CREATE INDEX idx_fingerprint_md5 ON file_fingerprint(file_md5);

-- 上传任务表（分片上传）
CREATE TABLE img_upload_task (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    upload_id TEXT NOT NULL UNIQUE,
    file_hash TEXT,
    file_name TEXT,
    file_size INTEGER NOT NULL,
    chunk_size INTEGER NOT NULL,
    total_chunks INTEGER NOT NULL,
    uploaded_chunks INTEGER DEFAULT 0,
    chunk_status TEXT,                -- JSON: 记录每个分片的状态
    status INTEGER DEFAULT 0,         -- 0-上传中 1-合并中 2-已完成 3-失败 4-过期
    uploader_id INTEGER,
    expires_at TEXT NOT NULL,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_upload_task_id ON img_upload_task(upload_id);
CREATE INDEX idx_upload_task_status ON img_upload_task(status);
CREATE INDEX idx_upload_task_expires ON img_upload_task(expires_at);

-- 异步任务表（替代 RocketMQ）
CREATE TABLE img_async_task (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_type TEXT NOT NULL,           -- thumbnail/convert/watermark/exif
    image_id INTEGER NOT NULL,
    payload TEXT,                      -- JSON 任务参数
    status INTEGER DEFAULT 0,          -- 0-待处理 1-处理中 2-完成 3-失败
    retry_count INTEGER DEFAULT 0,
    max_retries INTEGER DEFAULT 3,
    error_message TEXT,
    created_at TEXT DEFAULT (datetime('now')),
    updated_at TEXT DEFAULT (datetime('now')),
    executed_at TEXT,
    FOREIGN KEY (image_id) REFERENCES img_image(id)
);

CREATE INDEX idx_async_task_status ON img_async_task(status);
CREATE INDEX idx_async_task_type ON img_async_task(task_type, status);

-- 操作日志表
CREATE TABLE img_operation_log (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    operator_id INTEGER,
    operation_type TEXT NOT NULL,       -- upload/delete/update/download
    target_type TEXT NOT NULL,          -- image/album/tag
    target_id INTEGER,
    detail TEXT,                        -- JSON 操作详情
    ip_address TEXT,
    created_at TEXT DEFAULT (datetime('now'))
);

CREATE INDEX idx_log_operator ON img_operation_log(operator_id);
CREATE INDEX idx_log_created ON img_operation_log(created_at);
```

---

## 7. 部署方案

### 7.1 部署架构（最小化）

```
┌───────────────────────────────────────────────────────┐
│                  单台服务器 / 开发机                     │
│                                                        │
│  ┌────────────────────┐  ┌──────────────────────────┐ │
│  │  Docker Compose     │  │  Java 进程               │ │
│  │                     │  │                          │ │
│  │  ┌───────────────┐ │  │  ImgVault API (jar)      │ │
│  │  │   MinIO        │ │  │  · Spring Boot 2.7       │ │
│  │  │   Port: 9000   │ │  │  · SQLite (data/目录)    │ │
│  │  │   Console:9001 │ │  │  · Caffeine Cache       │ │
│  │  └───────────────┘ │  │  · Port: 8080            │ │
│  │                     │  │                          │ │
│  │  ┌───────────────┐ │  └──────────────────────────┘ │
│  │  │   imgproxy     │ │                               │
│  │  │   Port: 8081   │ │  ┌──────────────────────────┐│
│  │  │   ~50MB 内存   │ │  │  数据目录                 ││
│  │  └───────────────┘ │  │  data/imgvault.db         ││
│  │                     │  │  data/imgvault.db-wal     ││
│  └────────────────────┘  │  data/imgvault.db-shm     ││
│                           └──────────────────────────┘│
└───────────────────────────────────────────────────────┘
```

### 7.2 Docker Compose 配置

```yaml
# docker-compose.yml
version: '3.8'

services:
  # ==========================================
  # 对象存储: MinIO
  # ==========================================
  minio:
    image: minio/minio:latest
    container_name: imgvault-minio
    ports:
      - "9000:9000"     # S3 API
      - "9001:9001"     # Web Console
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"
    volumes:
      - minio-data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================
  # 图片处理: imgproxy (Go + libvips)
  # ==========================================
  imgproxy:
    image: darthsim/imgproxy:latest
    container_name: imgvault-imgproxy
    ports:
      - "8081:8080"
    environment:
      # S3/MinIO 后端配置
      IMGPROXY_USE_S3: "true"
      IMGPROXY_S3_ENDPOINT: "http://minio:9000"
      AWS_ACCESS_KEY_ID: "minioadmin"
      AWS_SECRET_ACCESS_KEY: "minioadmin"
      AWS_REGION: "us-east-1"
      
      # URL 签名（安全）
      IMGPROXY_KEY: "${IMGPROXY_KEY:-your-hex-key-here}"
      IMGPROXY_SALT: "${IMGPROXY_SALT:-your-hex-salt-here}"
      
      # 性能调优（低资源环境）
      IMGPROXY_CONCURRENCY: "2"              # 并发处理数（CPU 核心数 x 1）
      IMGPROXY_MAX_SRC_RESOLUTION: "50"      # 最大源图分辨率 (MP)
      IMGPROXY_MAX_ANIMATION_FRAMES: "100"   # 最大动图帧数
      IMGPROXY_DOWNLOAD_BUFFER_SIZE: "1048576"  # 1MB 下载缓冲
      
      # 内存优化
      IMGPROXY_MALLOC: "jemalloc"
      IMGPROXY_FREE_MEMORY_INTERVAL: "10"
      MALLOC_ARENA_MAX: "2"
      
      # 格式支持
      IMGPROXY_ENABLE_WEBP_DETECTION: "true"
      IMGPROXY_ENABLE_AVIF_DETECTION: "true"
      IMGPROXY_PREFERRED_FORMATS: "avif,webp,jpeg"
      
      # 水印配置
      IMGPROXY_WATERMARK_URL: "s3://imgvault/assets/watermark.png"
      IMGPROXY_WATERMARK_OPACITY: "0.5"
    depends_on:
      minio:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 64M

volumes:
  minio-data:
    driver: local
```

### 7.3 资源需求对比

| 组件 | v2.0.0 内存 | v2.1.0 内存 | 节省 |
|------|-----------|-----------|------|
| MySQL 8.0 | 512MB - 1GB | **0 (去掉)** | 100% |
| Redis 6.x | 100 - 200MB | **0 (去掉)** | 100% |
| RocketMQ 4.9.x | 512MB - 1GB | **0 (去掉)** | 100% |
| MinIO | 256MB | 256MB | 不变 |
| Java 服务 (3个) | 600 - 900MB | **150 - 200MB (1个)** | 70% |
| imgproxy | 0 (无) | 64 - 256MB | 新增 |
| **总计** | **~2.5 - 4GB** | **~470 - 712MB** | **~80%** |

### 7.4 最低硬件要求

| 指标 | 最低配置 | 推荐配置 |
|------|---------|---------|
| CPU | 1 核 | 2 核 |
| 内存 | 1GB | 2GB |
| 磁盘 | 20GB SSD | 100GB SSD |
| 网络 | 100Mbps | 1Gbps |
| 操作系统 | Linux / macOS | Linux (Ubuntu 22.04+) |

### 7.5 一键启动脚本

```bash
#!/bin/bash
# start.sh - ImgVault 一键启动

echo "=== ImgVault v2.1.0 启动 ==="

# 1. 创建数据目录
mkdir -p data

# 2. 生成 imgproxy 签名密钥（首次运行）
if [ ! -f .env ]; then
    echo "IMGPROXY_KEY=$(openssl rand -hex 32)" > .env
    echo "IMGPROXY_SALT=$(openssl rand -hex 32)" >> .env
    echo "已生成 imgproxy 签名密钥 (.env)"
fi

# 3. 启动 Docker 服务 (MinIO + imgproxy)
docker compose up -d

# 4. 等待 MinIO 就绪
echo "等待 MinIO 启动..."
until docker compose exec minio mc ready local 2>/dev/null; do
    sleep 2
done

# 5. 创建 MinIO Bucket
docker compose exec minio mc mb local/imgvault --ignore-existing

# 6. 启动 Java 服务
echo "启动 ImgVault API..."
java -jar -Xmx256m imgvault-api/target/imgvault-api.jar \
    --spring.profiles.active=dev &

echo "=== ImgVault 已启动 ==="
echo "API:     http://localhost:8080"
echo "imgproxy: http://localhost:8081"
echo "MinIO:   http://localhost:9001"
```

---

## 8. 技术选型总结

### 8.1 完整技术栈

| 组件 | v2.0.0 | v2.1.0 | 版本 |
|------|--------|--------|------|
| **Web 框架** | Spring Boot | Spring Boot | 2.7.x |
| **Java 版本** | Java 8 | Java 8 | 1.8 |
| **数据库** | MySQL 8.0 | **SQLite (WAL)** | sqlite-jdbc 3.46.x |
| **缓存** | Redis 6.x | **Caffeine** | 3.1.x |
| **消息队列** | RocketMQ 4.9.x | **Spring Async + SQLite 任务表** | - |
| **对象存储** | MinIO | MinIO | 8.5.x |
| **图片处理** | Thumbnailator + TwelveMonkeys | **imgproxy (Go + libvips)** | latest |
| **ORM** | MyBatis | MyBatis | 3.5.x |
| **元数据提取** | metadata-extractor | metadata-extractor | 2.19.x |
| **图片去重** | JImageHash | JImageHash | 1.0.0 |
| **对象映射** | MapStruct | MapStruct | 1.5.2 |
| **API 文档** | SpringDoc OpenAPI | SpringDoc OpenAPI | 1.7.x |
| **项目构建** | Maven | Maven | - |

### 8.2 去掉的依赖

| 依赖 | 替代方案 | 理由 |
|------|---------|------|
| MySQL 8.0 | SQLite | 零部署、零运维 |
| Redis 6.x | Caffeine | 零部署、更快 |
| RocketMQ 4.9.x | Spring Async + SQLite | 轻量化 |
| Thumbnailator 0.4.20 | imgproxy | 性能 5-10x |
| TwelveMonkeys 3.10.x | imgproxy | 格式更全面 |
| mysql-connector-java | sqlite-jdbc | 数据库更换 |
| spring-boot-starter-data-redis | spring-boot-starter-cache + caffeine | 缓存更换 |
| rocketmq-spring-boot-starter | spring-boot-starter-async | 异步方案更换 |

### 8.3 新增的依赖

```xml
<!-- SQLite JDBC -->
<dependency>
    <groupId>org.xerial</groupId>
    <artifactId>sqlite-jdbc</artifactId>
    <version>3.46.1.3</version>
</dependency>

<!-- Caffeine Cache -->
<dependency>
    <groupId>com.github.ben-manes.caffeine</groupId>
    <artifactId>caffeine</artifactId>
    <version>3.1.8</version>
</dependency>

<!-- Spring Boot Cache Starter -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-cache</artifactId>
</dependency>
```

---

## 9. 里程碑计划

### 总体时间线（9 周）

```
Week 1-3   ██████████████████████  Phase 1: 轻量化 MVP
Week 4-5   ██████████████          Phase 2: imgproxy 集成
Week 6-7   ██████████████          Phase 3: 高级上传功能
Week 8-9   ██████████████          Phase 4: 管理功能
Week 10+   ═══════════════ ···     Phase 5: 持续优化
```

### 详细计划

| 阶段 | 周次 | 任务 | 交付物 |
|------|------|------|--------|
| **Phase 1** | 第 1 周 | 脚手架搭建：Spring Boot + SQLite + Caffeine + MinIO + Docker Compose | 基础框架可运行 |
| | 第 2 周 | 图片上传/下载/查询核心功能 (F02-F06) | 核心 API 可用 |
| | 第 3 周 | 安全校验 + 元数据 + 删除 + 健康检查 (F03, F07-F10) | MVP 完成 |
| **Phase 2** | 第 4 周 | imgproxy Docker 集成 + 缩略图 URL + URL 签名 (F11-F13) | 图片处理可用 |
| | 第 5 周 | 格式转换 + 水印 + 压缩 + 智能裁剪 (F14-F17) | 图片处理全面 |
| **Phase 3** | 第 6 周 | 秒传 + 客户端直传 + 异步 EXIF (F18-F19, F22) | 高级上传功能 |
| | 第 7 周 | 分片上传 + 断点续传 + 异步任务表 (F20-F21, F23) | 大文件上传完成 |
| **Phase 4** | 第 8 周 | 标签管理 + 相册管理 (F24-F25) | 分类管理功能 |
| | 第 9 周 | 图片去重 + EXIF 展示 + 管理后台 API (F26-F30) | 管理功能完成 |

---

## 10. 非功能需求

### 10.1 性能需求

| 指标 | v2.0.0 目标 | v2.1.0 目标 | 说明 |
|------|-----------|-----------|------|
| 上传吞吐 | 500+ 张/分钟 | 300+ 张/分钟 | SQLite 单写限制，但够用 |
| 上传延迟 | P99 < 3s | P99 < 3s | 不变 |
| 下载延迟 | P99 < 200ms | P99 < 200ms | imgproxy 更快 |
| 查询延迟 | P99 < 100ms | P99 < 50ms | Caffeine 更快 |
| 缩略图延迟 | P99 < 2s | P99 < 500ms | imgproxy + libvips |
| 并发用户 | 1000+ | 100-500 | 轻量化定位 |

### 10.2 容量规划

| 指标 | 预期值 | 说明 |
|------|--------|------|
| 首年存储量 | 100GB - 500GB | 个人/小团队 |
| 图片数量 | 5 万 - 20 万张/年 | 轻量化定位 |
| SQLite 数据库大小 | < 500MB | 元数据为主 |
| 缩略图存储 | **0 (按需生成)** | imgproxy 实时处理 |

---

## 11. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| SQLite 并发写入瓶颈 | 低 | 中 | WAL 模式 + `busy_timeout` + 预留 MySQL 迁移路径 |
| SQLite 数据库文件损坏 | 极低 | 高 | 定时备份（复制 3 个文件） + WAL checkpoint |
| imgproxy 内存不足 | 低 | 中 | `IMGPROXY_CONCURRENCY=2` + `memory limit=256M` |
| imgproxy 处理延迟 | 低 | 低 | CDN 缓存 + Caffeine URL 缓存 |
| Caffeine 缓存一致性 | 中 | 低 | TTL 过期策略 + 写入时主动失效 |
| Docker for Mac SQLite WAL 问题 | 中 | 中 | 开发环境 Java 直接运行，不用 Docker |
| imgproxy 版本升级不兼容 | 低 | 低 | 锁定 Docker 镜像版本 |

---

## 12. 验收标准

### 12.1 功能验收

- [ ] 支持 JPEG/PNG/GIF/WebP/BMP 格式图片上传
- [ ] 原图字节流无损直存 MinIO（SHA-256 校验通过）
- [ ] Magic Bytes + 类型白名单安全校验正常
- [ ] SQLite WAL 模式正常运行，读写不互斥
- [ ] Caffeine 缓存命中率 > 70%
- [ ] imgproxy 缩略图 URL 正常返回图片
- [ ] imgproxy URL 签名验证有效
- [ ] AVIF/WebP 格式转换正常
- [ ] 分片上传 + 断点续传正常
- [ ] 秒传功能正常
- [ ] 标签/相册管理功能正常
- [ ] Docker Compose 一键启动成功

### 12.2 性能验收

- [ ] 单张 5MB 图片上传 P99 < 3s
- [ ] 图片查询 P99 < 50ms（Caffeine 缓存命中）
- [ ] imgproxy 缩略图生成 P99 < 500ms
- [ ] 总内存占用 < 1GB

### 12.3 部署验收

- [ ] Docker Compose 一键启动（MinIO + imgproxy）
- [ ] Java 服务 fat jar 独立运行
- [ ] 最低 1GB 内存服务器可运行全套服务
- [ ] SQLite 数据文件可正常备份和恢复

---

## 13. 附录

### 13.1 参考文档

- [imgproxy 官方文档](https://docs.imgproxy.net/)
- [imgproxy S3 配置](https://docs.imgproxy.net/image_sources/amazon_s3)
- [imgproxy 内存优化](https://docs.imgproxy.net/memory_usage_tweaks)
- [SQLite WAL 模式](https://sqlite.org/wal.html)
- [xerial/sqlite-jdbc](https://github.com/xerial/sqlite-jdbc)
- [Caffeine Cache](https://github.com/ben-manes/caffeine)
- [Spring Boot Caffeine 集成](https://www.baeldung.com/spring-boot-caffeine-cache)
- [Spring Boot 嵌入式数据库](https://docs.spring.io/spring-framework/reference/data-access/jdbc/embedded-database-support.html)

### 13.2 调研依据

- `docs/research/image-storage-service-research.md` — Java 生态图片服务调研
- `docs/research/image-service-language-comparison-research.md` — 多语言方案对比调研

### 13.3 决策记录

| 决策 | 选项 | 选择 | 理由 |
|------|------|------|------|
| 数据库 | MySQL / SQLite / H2 / DuckDB | **SQLite** | 零部署、Java/Go 双端支持、WAL 并发足够 |
| 缓存 | Redis / Caffeine / Memcached | **Caffeine** | 零部署、纳秒级延迟、Spring Boot 原生支持 |
| 消息队列 | RocketMQ / RabbitMQ / Spring Async | **Spring Async + SQLite** | 零部署、轻量化 |
| 图片处理 | Java 原生 / imgproxy / 自研 Go | **imgproxy** | 开箱即用、性能天花板、格式全面 |
| 部署方式 | K8s / Docker Compose / 裸机 | **Docker Compose + jar** | 最小化资源、一键部署 |

---

**最后更新**: 2026-02-13
