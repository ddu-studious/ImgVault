# 访客隔离方案 需求文档

**版本**: v2.4.0
**创建日期**: 2026-02-16
**状态**: 开发中

## 需求背景

当前 ImgVault 所有用户访问同一页面时，看到的是所有已上传的图片，没有用户隔离机制。需要实现在**无登录**场景下，不同浏览器/设备的访客只能看到自己上传的图片。

### 现状分析

- 用户端 `GET /api/v1/images` 返回所有 `status=1` 的图片，无用户过滤
- 上传接口不记录上传者身份
- `img_image` 表有 `uploader_id` 字段但未使用
- 管理端已有 Token 认证，但用户端完全公开

### 方案选型（已调研）

| 方案 | 唯一性 | 持久性 | 复杂度 | 隐私 | 结论 |
|------|--------|--------|--------|------|------|
| UUID + localStorage | 高（单设备） | 高 | 极低 | 友好 | **采用** |
| 浏览器指纹 | 中 | 低~中 | 低 | 需注意 | 备选 |
| MAC 地址 | - | - | - | - | 不可行 |
| Token-based | 高 | 可配置 | 中 | 中 | 过重 |

详细调研见：`docs/research/user-isolation-identification-research.md`

## 需求目标

1. 不同浏览器/设备访问用户端时，只能看到自己上传的图片
2. 管理端不受影响，管理员可查看所有图片
3. 实现简单、隐私友好、无需登录
4. 兼容现有功能（搜索、分页、排序等）

## 功能需求

### P0 - 核心功能

| ID | 功能 | 说明 |
|----|------|------|
| F01 | 访客 ID 生成 | 首次访问时前端生成 UUID 并存储到 localStorage |
| F02 | 访客 ID 传递 | 所有 API 请求通过 `X-Visitor-Id` Header 传递 |
| F03 | 上传关联访客 | 图片上传时，将 visitor_id 存入 img_image 表 |
| F04 | 查询隔离 | 用户端图片列表仅返回当前访客上传的图片 |
| F05 | 管理端无限制 | 管理端查询不受 visitor_id 过滤影响 |

### P1 - 增强功能

| ID | 功能 | 说明 |
|----|------|------|
| F06 | 隐私模式降级 | localStorage 不可用时降级到 sessionStorage |
| F07 | 历史数据兼容 | 已有图片 visitor_id 为空，仅管理端可见 |

## 技术方案

### 数据库变更

```sql
-- 新增 visitor_id 列
ALTER TABLE img_image ADD COLUMN visitor_id TEXT;

-- 添加索引
CREATE INDEX idx_image_visitor ON img_image(visitor_id);
```

### 后端变更

| 文件 | 变更内容 |
|------|----------|
| `ImageEntity.java` | 新增 `visitorId` 字段 |
| `ImageQueryRequest.java` | 新增 `visitorId` 字段 |
| `ImageMapper.xml` | resultMap/allColumns/insert 加 visitor_id；findPage/count 加条件 |
| `ImageMapper.java` | findPage/count 加 `visitorId` 参数 |
| `ImageRepository.java` | findPage/count 加 `visitorId` 参数 |
| `ImageRepositoryImpl.java` | 透传 `visitorId` 参数 |
| `ImageAppService.java` | uploadImage 接受/存储 visitorId；listImages 传递 visitorId |
| `ImageController.java` | 提取 `X-Visitor-Id` header，传递到 service |

### 前端变更

| 文件 | 变更内容 |
|------|----------|
| `frontend/app.js` | 新增 `getVisitorId()`；`api()` 函数添加 Header；上传 XHR 添加 Header |

### 调用链

```
用户端查询:
  app.js → api('/images') + Header: X-Visitor-Id
    → ImageController.list(@RequestHeader visitorId)
      → request.setVisitorId(visitorId)
        → ImageAppService.listImages(request)
          → imageRepository.findPage(..., visitorId, ...)
            → ImageMapper.findPage: WHERE visitor_id = #{visitorId}

用户端上传:
  app.js → POST /images/upload + Header: X-Visitor-Id
    → ImageController.upload(@RequestHeader visitorId, file)
      → ImageAppService.uploadImage(file, visitorId)
        → entity.setVisitorId(visitorId)
          → imageRepository.insert(entity)

管理端查询:
  admin.js → GET /admin/images + Header: Authorization
    → AdminController.listImages(request) [无 visitorId]
      → ImageAppService.listImages(request) [visitorId=null]
        → ImageMapper.findPage: WHERE status=#{status} [无 visitor_id 条件]
```

## 验收标准

- [x] 浏览器 A 上传的图片只在浏览器 A 可见
- [x] 浏览器 B 上传的图片只在浏览器 B 可见
- [x] 管理端可查看所有图片
- [x] 搜索/分页/排序功能正常
- [x] 清除浏览器数据后生成新 ID，旧图片不可见
- [x] 隐私模式下可正常使用（降级到 sessionStorage）

---

**最后更新**: 2026-02-16
