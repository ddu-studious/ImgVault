# 图片存储/查询服务 需求文档

**版本**: v2.0.0  
**创建日期**: 2026-02-10  
**状态**: 规划中  
**项目代号**: ImgVault

---

## 1. 需求背景

### 1.1 业务痛点

当前业务系统中图片资源分散存储，缺乏统一的图片管理能力：
- 图片存储分散在各个业务服务中，缺乏统一管理
- 缺少图片去重机制，存储资源浪费
- 图片处理（缩略图、水印等）由各业务自行实现，逻辑重复
- 没有统一的图片安全校验和访问控制
- 缺乏图片检索和分类管理能力

### 1.2 项目目标

构建一个独立的、高可用的**图片存储与查询服务（ImgVault）**，为所有业务系统提供统一的图片上传、存储、处理、检索和分发能力。

### 1.3 核心价值

| 价值维度 | 说明 |
|---------|------|
| 统一管理 | 所有图片资源集中管理，告别分散存储 |
| 降低成本 | 去重 + 压缩 + 冷热分离，节省存储成本 |
| 提升效率 | 统一 API，各业务快速接入 |
| 安全合规 | 统一的安全校验和访问控制 |
| 高可用 | 99.99% 可用性保障 |

---

## 2. 功能需求

### P0 - 核心功能（MVP）

| ID | 功能模块 | 功能描述 | 验收标准 |
|----|---------|---------|---------|
| F01 | 图片上传 | 支持单张/批量图片上传 | 支持 JPEG/PNG/GIF/WebP/BMP 格式 |
| F02 | 图片上传 | 支持客户端直传（Presigned URL） | 生成预签名 URL，客户端直接上传至 MinIO |
| F03 | 图片上传 | 文件安全校验 | Magic Bytes 校验 + 类型白名单 + 大小限制 |
| F04 | 图片存储 | 基于 MinIO 的对象存储 | 支持桶管理、路径规划、存储策略 |
| F05 | 图片查询 | 根据 ID/UUID 查询图片 | 返回图片 URL + 元数据信息 |
| F06 | 图片查询 | 分页列表查询 | 支持按时间、格式、大小排序和筛选 |
| F07 | 图片下载 | 支持原图下载 | 支持预签名 URL 下载 |
| F08 | 图片删除 | 支持软删除和物理删除 | 软删除可恢复，物理删除释放存储空间 |
| F09 | 元数据管理 | 自动提取和存储图片元数据 | 尺寸、格式、大小、EXIF 信息 |
| F10 | 健康检查 | 服务健康检查和监控 | /actuator/health 端点 |

### P1 - 重要功能

| ID | 功能模块 | 功能描述 | 验收标准 |
|----|---------|---------|---------|
| F11 | 缩略图 | 自动生成多规格缩略图 | small(150x150)、medium(800x600)、large(1920x1080) |
| F12 | 图片处理 | 支持图片裁剪、旋转 | 按指定尺寸或区域裁剪 |
| F13 | 图片处理 | 支持添加水印 | 文字水印 + 图片水印，可配置位置和透明度 |
| F14 | 图片处理 | 支持格式转换 | JPEG ↔ PNG ↔ WebP 互转 |
| F15 | 图片处理 | 支持图片压缩 | 可配置压缩质量 (1-100) |
| F16 | 秒传 | 基于哈希的文件秒传 | SHA-256 + MD5 双重哈希校验 |
| F17 | 分片上传 | 大文件分片上传 | 支持 5MB-20MB 可配置分片大小 |
| F18 | 断点续传 | 网络中断后恢复上传 | Redis 记录分片状态，仅重传失败分片 |
| F19 | 标签管理 | 图片标签的增删改查 | 支持多标签，按标签检索图片 |
| F20 | 相册管理 | 图片分组/相册功能 | 支持创建相册、添加/移除图片 |

### P2 - 增强功能

| ID | 功能模块 | 功能描述 | 验收标准 |
|----|---------|---------|---------|
| F21 | 图片去重 | 感知哈希相似图检测 | 基于 JImageHash，可配置相似度阈值 |
| F22 | EXIF 管理 | EXIF 元数据提取与展示 | 拍摄设备、拍摄参数、GPS 位置等 |
| F23 | EXIF 管理 | EXIF 隐私清理 | 上传时可选移除 GPS 等敏感 EXIF |
| F24 | 访问统计 | 图片访问量统计 | 记录访问次数、访问来源 |
| F25 | 冷热分离 | 基于访问频率的存储分层 | 30 天未访问自动迁移至冷存储 |
| F26 | 图片审核 | 集成内容审核能力 | 异步审核 + 人工复审入口 |
| F27 | 回收站 | 已删除图片的回收站功能 | 30 天内可恢复 |
| F28 | 操作日志 | 记录所有图片操作日志 | 上传/删除/修改/下载操作审计 |
| F29 | 批量操作 | 批量删除、批量打标签、批量下载 | 单次最多 100 张 |
| F30 | 管理后台 | 图片资源管理后台 | 图片浏览、搜索、审核、统计 |

---

## 3. 非功能需求

### 3.1 性能需求

| 指标 | 目标值 | 说明 |
|------|--------|------|
| 上传吞吐 | 500+ 张/分钟 | 单实例，5MB 平均大小 |
| 上传延迟 | P99 < 3s | 5MB 图片，含校验和处理 |
| 下载延迟 | P99 < 200ms | CDN 命中场景 |
| 查询延迟 | P99 < 100ms | 单条查询含元数据 |
| 列表查询 | P99 < 500ms | 分页查询，20 条/页 |
| 并发用户 | 1000+ | 同时在线用户 |

### 3.2 可用性需求

| 指标 | 目标值 |
|------|--------|
| 服务可用性 | 99.99%（年停机 < 52 分钟） |
| 数据持久性 | 99.999999999%（11 个 9） |
| 故障恢复 | RTO < 5 分钟，RPO < 1 分钟 |

### 3.3 安全需求

| 需求 | 说明 |
|------|------|
| 文件校验 | Magic Bytes + 类型白名单 + 大小限制 |
| 访问控制 | 预签名 URL + Token 鉴权 |
| 防盗链 | Referer 校验 + IP 限流 |
| EXIF 隐私 | 可选移除敏感元数据 |
| 数据加密 | 传输 HTTPS + 存储加密（MinIO SSE） |
| 审计追踪 | 所有操作记录审计日志 |

### 3.4 存储需求

| 指标 | 初始估算 |
|------|---------|
| 首年存储量 | 500GB - 1TB |
| 图片平均大小 | 2-5MB |
| 预计图片数量 | 10 万 - 50 万张/年 |
| 存储扩展 | 支持横向扩展至 PB 级 |

### 3.5 兼容性需求

| 需求 | 说明 |
|------|------|
| S3 API 兼容 | 核心接口兼容 S3 协议 |
| 多端支持 | Web / App / 第三方系统 |
| 格式支持 | JPEG, PNG, GIF, WebP, BMP, TIFF |
| 浏览器 | Chrome 90+, Firefox 88+, Safari 14+ |

---

## 4. 系统架构

### 4.1 整体架构

```
                           ┌─────────────────┐
                           │   客户端/浏览器   │
                           └────────┬────────┘
                                    │
                           ┌────────▼────────┐
                           │   负载均衡 (LB)  │
                           └────────┬────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
           ┌────────▼──────┐ ┌─────▼──────┐ ┌──────▼──────┐
           │ ImgVault API  │ │  Admin API │ │  Task API   │
           │   (图片服务)   │ │  (管理后台) │ │  (异步任务)  │
           └────────┬──────┘ └─────┬──────┘ └──────┬──────┘
                    │              │                │
           ┌────────▼──────────────▼────────────────▼──────┐
           │                  应用层 (App)                   │
           │     上传编排 / 查询编排 / 处理编排 / 任务编排     │
           └────────────────────┬───────────────────────────┘
                                │
           ┌────────────────────▼───────────────────────────┐
           │                 领域层 (Domain)                  │
           │  图片聚合根 / 相册聚合根 / 标签 / 上传任务        │
           └────────────────────┬───────────────────────────┘
                                │
           ┌────────────────────▼───────────────────────────┐
           │              基础设施层 (Infrastructure)         │
           │                                                │
           │  ┌─────────┐ ┌─────────┐ ┌──────────────────┐ │
           │  │  MySQL   │ │  Redis  │ │  MinIO (S3)      │ │
           │  │ (元数据)  │ │ (缓存)  │ │ (图片文件存储)    │ │
           │  └─────────┘ └─────────┘ └──────────────────┘ │
           │                                                │
           │  ┌─────────────┐ ┌───────────────────────────┐│
           │  │ RocketMQ    │ │  Thumbnailator + 12Monkeys ││
           │  │ (消息队列)   │ │  (图片处理)                ││
           │  └─────────────┘ └───────────────────────────┘│
           └────────────────────────────────────────────────┘
```

### 4.2 模块划分

| 模块 | 说明 | 端口 |
|------|------|------|
| `imgvault-api` | 对外 API 服务，图片上传/下载/查询 | 8080 |
| `imgvault-admin` | 管理后台，图片管理/审核/统计 | 8082 |
| `imgvault-app` | 应用层，业务编排 | - |
| `imgvault-common` | 公共模块，DTO/枚举/工具类 | - |
| `imgvault-domain` | 领域层，核心业务逻辑 | - |
| `imgvault-infrastructure` | 基础设施层，存储/缓存/消息 | - |
| `imgvault-task` | 异步任务服务（缩略图生成、格式转换等） | 8084 |

### 4.3 存储路径规划

```
imgvault/                          # MinIO Bucket
├── originals/                     # 原图
│   ├── 2026/02/10/               # 按日期分目录
│   │   ├── {uuid}.jpg
│   │   └── {uuid}.png
├── thumbnails/                    # 缩略图
│   ├── small/                    # 150x150
│   │   └── {uuid}_s.jpg
│   ├── medium/                   # 800x600
│   │   └── {uuid}_m.jpg
│   └── large/                    # 1920x1080
│       └── {uuid}_l.jpg
├── watermarked/                   # 水印图
│   └── {uuid}_w.jpg
├── temp/                          # 临时文件（分片上传暂存）
│   └── {uploadId}/
│       ├── chunk_0
│       ├── chunk_1
│       └── ...
└── avatars/                       # 头像专用（业务扩展）
    └── {userId}.jpg
```

---

## 5. API 设计

### 5.1 图片上传 API

#### 5.1.1 普通上传

```
POST /api/v1/images/upload
Content-Type: multipart/form-data

Request:
  - file: 图片文件 (必填)
  - tags: 标签列表 (可选, 逗号分隔)
  - album_id: 相册ID (可选)
  - description: 描述 (可选)
  - access_level: 访问级别 (可选, 默认 public)
  - strip_exif: 是否清除EXIF (可选, 默认 false)

Response: 201 Created
{
    "code": 0,
    "data": {
        "image_id": "img_2026021012345",
        "uuid": "550e8400-e29b-41d4-a716-446655440000",
        "url": "https://cdn.example.com/originals/2026/02/10/550e8400.jpg",
        "thumbnails": {
            "small": "https://cdn.example.com/thumbnails/small/550e8400_s.jpg",
            "medium": "https://cdn.example.com/thumbnails/medium/550e8400_m.jpg"
        },
        "metadata": {
            "width": 1920,
            "height": 1080,
            "format": "jpeg",
            "size": 2048576
        }
    }
}
```

#### 5.1.2 获取预签名上传 URL

```
POST /api/v1/images/presigned-upload
Content-Type: application/json

Request:
{
    "file_name": "photo.jpg",
    "file_size": 2048576,
    "content_type": "image/jpeg",
    "file_hash": "sha256:abc123..."
}

Response: 200 OK
{
    "code": 0,
    "data": {
        "upload_url": "https://minio.example.com/imgvault/originals/...",
        "upload_id": "upload_12345",
        "expires_at": "2026-02-10T13:00:00Z",
        "already_exists": false
    }
}
```

#### 5.1.3 初始化分片上传

```
POST /api/v1/images/multipart/init
Content-Type: application/json

Request:
{
    "file_name": "large_photo.jpg",
    "file_size": 52428800,
    "file_hash": "sha256:abc123...",
    "chunk_size": 5242880
}

Response: 200 OK
{
    "code": 0,
    "data": {
        "upload_id": "upload_67890",
        "total_chunks": 10,
        "chunk_size": 5242880,
        "uploaded_chunks": [],
        "already_exists": false
    }
}
```

#### 5.1.4 上传分片

```
PUT /api/v1/images/multipart/{uploadId}/chunks/{chunkIndex}
Content-Type: application/octet-stream

Response: 200 OK
{
    "code": 0,
    "data": {
        "chunk_index": 0,
        "etag": "abc123"
    }
}
```

#### 5.1.5 完成分片上传

```
POST /api/v1/images/multipart/{uploadId}/complete

Response: 201 Created
{
    "code": 0,
    "data": {
        "image_id": "img_2026021067890",
        "url": "https://cdn.example.com/originals/..."
    }
}
```

### 5.2 图片查询 API

#### 5.2.1 获取单张图片

```
GET /api/v1/images/{imageId}

Response: 200 OK
{
    "code": 0,
    "data": {
        "id": "img_2026021012345",
        "uuid": "550e8400-e29b-41d4-a716-446655440000",
        "original_name": "photo.jpg",
        "url": "https://cdn.example.com/originals/...",
        "thumbnails": { ... },
        "metadata": {
            "width": 1920,
            "height": 1080,
            "format": "jpeg",
            "size": 2048576,
            "color_space": "RGB"
        },
        "exif": {
            "camera": "Canon EOS R5",
            "lens": "RF 24-70mm F2.8",
            "taken_at": "2026-02-09T15:30:00Z"
        },
        "tags": ["风景", "日落"],
        "album": "旅行相册",
        "created_at": "2026-02-10T10:00:00Z",
        "view_count": 128
    }
}
```

#### 5.2.2 分页查询图片列表

```
GET /api/v1/images?page=1&size=20&sort=created_at&order=desc&format=jpeg&tag=风景

Response: 200 OK
{
    "code": 0,
    "data": {
        "items": [ ... ],
        "pagination": {
            "page": 1,
            "size": 20,
            "total": 1500,
            "pages": 75
        }
    }
}
```

#### 5.2.3 按标签查询

```
GET /api/v1/images/search?tags=风景,日落&match=all
```

#### 5.2.4 按哈希查询（去重检查）

```
GET /api/v1/images/hash/{fileHash}
```

### 5.3 图片处理 API

#### 5.3.1 生成缩略图

```
POST /api/v1/images/{imageId}/thumbnails
Content-Type: application/json

Request:
{
    "specifications": [
        {"type": "small", "width": 150, "height": 150, "mode": "crop"},
        {"type": "medium", "width": 800, "height": 600, "mode": "fit"},
        {"type": "custom", "width": 400, "height": 400, "mode": "fill", "quality": 85}
    ]
}
```

#### 5.3.2 添加水印

```
POST /api/v1/images/{imageId}/watermark
Content-Type: application/json

Request:
{
    "type": "text",
    "content": "ImgVault",
    "position": "bottom_right",
    "opacity": 0.5,
    "font_size": 24,
    "color": "#FFFFFF"
}
```

#### 5.3.3 格式转换

```
POST /api/v1/images/{imageId}/convert
Content-Type: application/json

Request:
{
    "target_format": "webp",
    "quality": 80
}
```

### 5.4 相册管理 API

```
POST   /api/v1/albums                          # 创建相册
GET    /api/v1/albums                          # 查询相册列表
GET    /api/v1/albums/{albumId}                # 获取相册详情
PUT    /api/v1/albums/{albumId}                # 更新相册信息
DELETE /api/v1/albums/{albumId}                # 删除相册
POST   /api/v1/albums/{albumId}/images         # 添加图片到相册
DELETE /api/v1/albums/{albumId}/images/{imageId} # 从相册移除图片
```

### 5.5 标签管理 API

```
GET    /api/v1/tags                            # 查询标签列表（含使用次数）
POST   /api/v1/images/{imageId}/tags           # 为图片添加标签
DELETE /api/v1/images/{imageId}/tags/{tagId}   # 移除图片标签
GET    /api/v1/tags/{tagId}/images             # 查询标签下的图片
```

---

## 6. 技术方案

### 6.1 技术选型

| 组件 | 技术选择 | 版本 | 理由 |
|------|---------|------|------|
| Web 框架 | Spring Boot | 2.7.x | 与现有项目保持一致 |
| Java 版本 | Java 8+ | 1.8 | 与现有项目保持一致 |
| 对象存储 | MinIO | 8.5.x | S3 兼容、低运维、高性能 |
| 数据库 | MySQL | 8.0 | 与现有项目保持一致 |
| 缓存 | Redis | 6.x | 缓存元数据 + 分片状态 |
| ORM | MyBatis | 3.5.x | 与现有项目保持一致 |
| 图片处理 | Thumbnailator | 0.4.20 | 功能全面、API 简洁 |
| 格式扩展 | TwelveMonkeys | 3.10.x | 支持 WebP/TIFF 等 |
| 元数据提取 | metadata-extractor | 2.19.x | 成熟稳定 |
| 图片去重 | JImageHash | 1.0.0 | 感知哈希 |
| 对象映射 | MapStruct | 1.5.2 | 与现有项目保持一致 |
| API 文档 | SpringDoc OpenAPI | 1.7.x | OpenAPI 3.0 标准 |
| 消息队列 | RocketMQ | 4.9.x | 异步图片处理任务 |
| 任务调度 | XXL-Job (可选) | 2.4.x | 定时清理/统计任务 |

### 6.2 DDD 分层设计

```
imgvault-api/               → 接口层：Controller、请求/响应 DTO
imgvault-admin/             → 管理接口层：管理后台 Controller
imgvault-app/               → 应用层：Service 编排、事件处理
imgvault-domain/            → 领域层：聚合根、领域服务、领域事件
imgvault-infrastructure/    → 基础设施层：Mapper、MinIO 客户端、Redis 封装
imgvault-common/            → 公共层：枚举、工具类、通用 DTO
imgvault-task/              → 任务服务：异步图片处理
```

### 6.3 核心流程

#### 图片上传流程

```
1. 客户端发起上传请求
2. API 层接收文件，校验参数
3. 安全校验：文件类型白名单 + Magic Bytes + 大小限制
4. 计算文件 SHA-256 哈希
5. 查询数据库检查是否已存在（秒传判断）
   - 已存在 → 增加引用计数，返回 URL
   - 不存在 → 继续上传
6. 上传原图至 MinIO
7. 提取 EXIF 元数据
8. 保存图片元数据到 MySQL
9. 发送异步消息：生成缩略图
10. 返回图片 URL 和元数据
```

#### 图片处理流程（异步）

```
1. 消费者接收图片处理消息
2. 从 MinIO 下载原图
3. 执行处理：生成缩略图 / 添加水印 / 格式转换
4. 上传处理结果至 MinIO
5. 更新数据库记录
6. 更新缓存
```

---

## 7. 部署架构

### 7.1 开发环境

```yaml
# docker-compose.yml
services:
  minio:
    image: minio/minio:latest
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    command: server /data --console-address ":9001"

  mysql:
    image: mysql:8.0
    ports:
      - "3306:3306"
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: imgvault

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
```

### 7.2 环境配置

| 环境 | 配置文件 | MinIO | MySQL |
|------|---------|-------|-------|
| 开发 | application-dev.yml | localhost:9000 | localhost:3306 |
| 测试 | application-test.yml | test-minio:9000 | test-mysql:3306 |
| 预发 | application-pre.yml | pre-minio:9000 | pre-mysql:3306 |
| 生产 | application-prod.yml | prod-minio:9000 | prod-mysql:3306 |

---

## 8. 里程碑计划

### Phase 1 - MVP（4 周）

| 周次 | 任务 | 交付物 |
|------|------|--------|
| 第 1 周 | 项目脚手架搭建 + MinIO 集成 | 基础框架、MinIO 连通 |
| 第 2 周 | 图片上传/下载/查询核心功能 | 核心 API (F01-F07) |
| 第 3 周 | 元数据管理 + 安全校验 | 元数据提取 (F03, F09) |
| 第 4 周 | 删除功能 + 健康检查 + 联调 | MVP 完成 (F08, F10) |

### Phase 2 - 图片处理（3 周）

| 周次 | 任务 | 交付物 |
|------|------|--------|
| 第 5 周 | 缩略图生成 + 水印 | F11, F13 |
| 第 6 周 | 格式转换 + 压缩 + 分片上传 | F14, F15, F17 |
| 第 7 周 | 秒传 + 断点续传 | F16, F18 |

### Phase 3 - 管理功能（3 周）

| 周次 | 任务 | 交付物 |
|------|------|--------|
| 第 8 周 | 标签管理 + 相册管理 | F19, F20 |
| 第 9 周 | 图片去重 + EXIF 管理 | F21, F22, F23 |
| 第 10 周 | 管理后台 + 操作日志 | F28, F30 |

### Phase 4 - 优化增强（持续）

- 冷热分离 (F25)
- 访问统计 (F24)
- 内容审核 (F26)
- 回收站 (F27)
- 批量操作 (F29)

---

## 9. 验收标准

### 9.1 功能验收

- [ ] 支持 JPEG/PNG/GIF/WebP/BMP 格式图片上传
- [ ] 支持单张和批量上传（最多 20 张/次）
- [ ] 支持预签名 URL 客户端直传
- [ ] 支持分片上传（大于 5MB 文件）
- [ ] 支持断点续传和秒传
- [ ] 支持缩略图自动生成（3 种规格）
- [ ] 支持添加文字/图片水印
- [ ] 支持图片格式互转
- [ ] 支持按标签/日期/格式检索图片
- [ ] 支持相册管理
- [ ] 支持 EXIF 元数据提取和展示
- [ ] 安全校验通过（文件类型/大小/内容）
- [ ] 管理后台可正常管理图片

### 9.2 性能验收

- [ ] 单张 5MB 图片上传 P99 < 3s
- [ ] 图片查询 P99 < 100ms
- [ ] 缩略图生成 P99 < 2s
- [ ] 服务可用性 > 99.99%

### 9.3 安全验收

- [ ] 非法文件类型上传被拦截
- [ ] 超大文件上传被拦截
- [ ] 预签名 URL 过期后无法访问
- [ ] 敏感 EXIF 信息可被清除

---

## 10. 风险评估

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|---------|
| MinIO 存储容量不足 | 低 | 高 | 监控存储使用率，提前扩容 |
| 图片处理消耗大量 CPU | 中 | 中 | 异步处理 + 限流 + 独立部署 Task 服务 |
| 恶意文件上传 | 中 | 高 | 多层安全校验 + 定期安全扫描 |
| 大文件上传超时 | 中 | 中 | 分片上传 + 断点续传 |
| 哈希碰撞导致误去重 | 极低 | 高 | 双重哈希（SHA-256 + MD5）+ 文件大小校验 |

---

**最后更新**: 2026-02-10
